<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test - Telegram Mini App</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { border-color: #4CAF50; background: #f8fff8; }
        .error { border-color: #f44336; background: #fff8f8; }
        .warning { border-color: #ff9800; background: #fffbf8; }
        button {
            background: #0070f3;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056cc; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            font-size: 12px;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            width: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ API Testing - Telegram Mini App</h1>

        <div class="section success">
            <h2>‚úÖ –ü—É–±–ª–∏—á–Ω—ã–µ API (–±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)</h2>

            <button onclick="testPublicContentTree()">üìÑ –ü—É–±–ª–∏—á–Ω–æ–µ –¥–µ—Ä–µ–≤–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</button>
            <button onclick="testDatabaseConnection()">üóÑÔ∏è –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î</button>
            <button onclick="testEnvironmentVariables()">üîç –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è</button>
            <button onclick="testHealthCheck()">‚ù§Ô∏è Health Check</button>

            <div id="public-results"></div>
        </div>

        <div class="section warning">
            <h2>üîê Debug API (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)</h2>

            <button onclick="testDebugAuth()">üîë –ü–æ–ª—É—á–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π JWT</button>
            <button onclick="testDebugContentTree()">üìã Debug –¥–µ—Ä–µ–≤–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</button>

            <div id="debug-results"></div>
        </div>

        <div class="section">
            <h2>üöÄ –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ API (—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π)</h2>

            <label>JWT Token: <input type="text" id="jwt-token" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ JWT —Ç–æ–∫–µ–Ω"></label>
            <br><br>

            <button onclick="testProtectedContentTree()">üìÑ –ó–∞—â–∏—â–µ–Ω–Ω–æ–µ –¥–µ—Ä–µ–≤–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</button>

            <div id="protected-results"></div>
        </div>

        <div class="section warning">
            <h2>‚öôÔ∏è –ê–¥–º–∏–Ω —Ñ—É–Ω–∫—Ü–∏–∏</h2>
            <p><strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–Ω–∏–º–∞–µ—Ç–µ —á—Ç–æ –¥–µ–ª–∞–µ—Ç–µ!</p>
            <br>
            <button onclick="runDatabaseMigration()" style="background: #ff6b35;">üóÑÔ∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î</button>
            <button onclick="seedDatabase()">üå± –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏</button>

            <div id="admin-results"></div>
        </div>

        <div class="section">
            <h2>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
            <div id="results"></div>
        </div>
    </div>

    <script>
        async function makeRequest(url, options = {}) {
            try {
                const response = await fetch(url, options);
                const data = await response.json();

                return {
                    status: response.status,
                    ok: response.ok,
                    data: data
                };
            } catch (error) {
                return {
                    status: 0,
                    ok: false,
                    error: error.message
                };
            }
        }

        function displayResult(elementId, result, title) {
            const element = document.getElementById(elementId);
            const statusClass = result.ok ? 'success' : 'error';

            element.innerHTML = `
                <div class="section ${statusClass}">
                    <h3>${title}</h3>
                    <p><strong>Status:</strong> ${result.status}</p>
                    <p><strong>Success:</strong> ${result.ok ? '‚úÖ' : '‚ùå'}</p>
                    <pre>${JSON.stringify(result.data || result.error, null, 2)}</pre>
                </div>
            ` + element.innerHTML;
        }

        // Public API tests
        async function testPublicContentTree() {
            const result = await makeRequest('/api/public/content-tree');
            displayResult('results', result, 'üåê –ü—É–±–ª–∏—á–Ω–æ–µ –¥–µ—Ä–µ–≤–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞');
        }

        async function testDatabaseConnection() {
            const result = await makeRequest('/api/debug/database');
            displayResult('results', result, 'üóÑÔ∏è –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
        }

        async function testEnvironmentVariables() {
            const result = await makeRequest('/api/test-database');
            displayResult('results', result, 'üîç –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è');
        }

        async function testHealthCheck() {
            const result = await makeRequest('/api/health');
            displayResult('results', result, '‚ù§Ô∏è Health Check');
        }

        // Debug API tests
        async function testDebugAuth() {
            const result = await makeRequest('/api/debug/auth');
            displayResult('results', result, 'üîë Debug JWT Token');

            // Auto-fill JWT token if successful
            if (result.ok && result.data.token) {
                document.getElementById('jwt-token').value = result.data.token;
            }
        }

        async function testDebugContentTree() {
            const result = await makeRequest('/api/debug/content-tree');
            displayResult('results', result, 'üìã Debug –¥–µ—Ä–µ–≤–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞');
        }

        // Protected API tests
        async function testProtectedContentTree() {
            const token = document.getElementById('jwt-token').value;

            if (!token) {
                displayResult('results', {
                    ok: false,
                    status: 400,
                    error: 'JWT —Ç–æ–∫–µ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω'
                }, '‚ùå –û—à–∏–±–∫–∞: –ù–µ—Ç JWT —Ç–æ–∫–µ–Ω–∞');
                return;
            }

            const result = await makeRequest('/api/content/tree', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            displayResult('results', result, 'üîê –ó–∞—â–∏—â–µ–Ω–Ω–æ–µ –¥–µ—Ä–µ–≤–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞');
        }

        // Admin functions
        async function runDatabaseMigration() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö? –≠—Ç–æ –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö.')) {
                return;
            }

            const result = await makeRequest('/api/admin/migrate', { method: 'POST' });
            displayResult('admin-results', result, 'üóÑÔ∏è –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö');
        }

        async function seedDatabase() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏? –≠—Ç–æ –¥–æ–±–∞–≤–∏—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏.')) {
                return;
            }

            const result = await makeRequest('/api/admin/seed', { method: 'POST' });
            displayResult('admin-results', result, 'üå± –°–∏–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö');
        }

        // Auto-run basic tests on page load
        window.onload = async function() {
            console.log('üöÄ Starting API tests...');

            // Test environment variables first
            await testEnvironmentVariables();

            // Small delay
            setTimeout(async () => {
                await testHealthCheck();
            }, 500);

            // Another delay
            setTimeout(async () => {
                await testDatabaseConnection();
            }, 1000);
        };
    </script>
</body>
</html>
